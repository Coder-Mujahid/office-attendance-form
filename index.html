<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Office Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600&display=swap" rel="stylesheet">
  <style>body { font-family: 'Sora', sans-serif; }</style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
  <div id="app" class="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden">
    <!-- Loading -->
    <div v-if="loading" class="p-8 text-center">Checking your network...</div>

    <!-- IP Check Result -->
    <div v-else-if="!allowed" class="p-6">
      <div class="rounded-md border border-rose-200 bg-rose-50 p-4">
        <p class="text-rose-700 font-medium">Access Denied</p>
        <p class="text-sm text-rose-600 mt-1">
          Attendance can only be submitted from office Wi-Fi.
        </p>
        <p class="text-xs text-slate-500 mt-2">
          Your IP: <span class="font-mono">{{ userIP || 'unknown' }}</span>
        </p>
      </div>
    </div>

    <!-- Form -->
    <div v-else class="p-6">
      <h2 class="text-xl font-semibold text-center mb-6">Office Attendance</h2>
      
      <form @submit.prevent="submit" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Employee ID</label>
          <input 
            v-model="id" 
            type="text" 
            inputmode="numeric"
            class="w-full px-4 py-3 rounded-lg border border-slate-200 focus:ring-2 focus:ring-blue-500"
            placeholder="e.g., 19112"
            required
          />
          <p v-if="error && !employees[id]" class="text-xs text-rose-600 mt-1">{{ error }}</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Name</label>
          <input 
            :value="employees[id] || ''"
            readonly
            class="w-full px-4 py-3 rounded-lg border border-slate-200 bg-slate-50"
            placeholder="Auto-filled"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Action</label>
          <select 
            v-model="type"
            class="w-full px-4 py-3 pr-10 rounded-lg border border-slate-200 appearance-none"
          >
            <option>Check-In</option>
            <option>Check-Out</option>
          </select>
        </div>

        <button 
          type="submit"
          :disabled="!id || !employees[id] || submitting"
          class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:bg-slate-300"
        >
          {{ submitting ? 'Submitting...' : 'Submit Attendance' }}
        </button>

        <div v-if="success" class="text-green-700 text-center p-3 bg-green-50 rounded">
          {{ success }}
        </div>
        <div v-if="error && employees[id]" class="text-rose-700 text-center p-3 bg-rose-50 rounded">
          {{ error }}
        </div>
      </form>
    </div>
  </div>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script>
    const { createApp, ref, onMounted } = Vue;

    createApp({
      setup() {
        const userIP = ref(null);
        const allowed = ref(false);
        const id = ref('');
        const type = ref('Check-In');
        const loading = ref(true);
        const submitting = ref(false);
        const success = ref('');
        const error = ref('');

        const employees = {
          "19112": "Sufiya Akter",
          "20060": "rafiul islam",
          "19281": "Md. Hosain Ali",
          "19057": "Siyam",
          "19117": "tamim",
          "19449": "ishtique",
          "19820": "soubir saian",
          "19678": "rakibul islam",
          "19228": "Mojahidul",
          "19146": "Srabon Dev",
          "19390": "Md. Jubayed Islam",
          "19127": "Manik Sarkar",
          "19604": "Sakib Al Zabir",
          "19381": "Hridoy Hossain",
          "19198": "Foisal",
          "20050": "Robiul Awal Mohin",
          "19124": "Thakur Saad",
          "19439": "Hasnain",
          "19043": "khusi Akter",
          "19264": "Ahsan Mahfuz",
          "19388": "Md Mehedi Hasan",
          "19095": "Jahid Hassan",
          "19801": "Md. Shadhin Ali",
          "19703": "Sahin Shiraz",
          "19248": "Sadia"
        };

        onMounted(async () => {
          try {
            const res = await fetch('https://api.ipify.org?format=json');
            const data = await res.json();
            userIP.value = data.ip;
            allowed.value = (data.ip === '103.159.73.129');
          } catch (err) {
            userIP.value = 'unknown';
            allowed.value = false;
          } finally {
            loading.value = false;
          }
        });

        const submit = async () => {
          error.value = '';
          success.value = '';
          submitting.value = true;

          const payload = {
            empId: id.value,
            name: employees[id.value],
            type: type.value,
            ip: userIP.value  // ðŸ”‘ Critical for IP validation
          };

          try {
            // ðŸš¨ REPLACE WITH YOUR ACTUAL APPS SCRIPT URL
            const res = await fetch('https://script.google.com/macros/s/AKfycbxvPFji9okYUTvUbcGwvhES5TpHJDE86Hqb94a1nGQK/dev', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (res.ok && result.success) {
              success.value = 'Attendance recorded! âœ…';
              id.value = '';
            } else {
              error.value = result.error || 'Submission failed.';
            }
          } catch (err) {
            error.value = 'Network error. Try again.';
          } finally {
            submitting.value = false;
          }
        };

        return {
          userIP,
          allowed,
          id,
          type,
          loading,
          submitting,
          success,
          error,
          employees,
          submit
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
